<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>我的</title>
    <link rel="stylesheet" href="../source/mui/css/mui.css">
    <link rel="stylesheet" href="../source/css/mui_overwrite.css">
    <link rel="stylesheet" href="../source/css/public.css">
    <link href="../source/css/searchcity.css" rel="stylesheet" />
    <script src="../source/js/jquery-1.11.1.min.js"></script>
    <script src="../source/mui/js/mui.js"></script>
    <script src="../source/js/ajax.js"></script>
    <script src="../source/js/public.js"></script>
    <style>
    .mui-search .mui-placeholder{
        padding-right: 50px;
    }
    .mui-indexed-list {
        background-color: transparent;
    }
    </style>
</head>
<body>
    <div class="mui-content mui-fullscreen" style="padding-top: 54px;">
        <div style="padding: 10px 15px;background-color: #fff;position: absolute;top:0;left:0;width: 100%;">
            <div class="mui-indexed-list-search mui-input-row mui-search mui-search-withButton" style="border-bottom: none;">
                <input id="searchCityInput" type="search" placeholder="请输入您需要搜索的教材" value="">
                <div class="mui-search-button mui-action-back linkColor">取消</div>
            </div>
        </div>
        <div id="hotSearchBlock">
            <h5 style="margin-top: 15px;">热门搜索</h5>
            <div class="user-city-list">
                <div id="user_city_row" class="user-city-row">
                    <div class="user-city-item">毛概马哲</div>
                    <div class="user-city-item">心理学</div>
                    <div class="user-city-item">经济学</div>
                    <div class="user-city-item">数据库</div>
                    <div class="user-city-item">Java</div>
                    <div class="user-city-item">艺术史</div>
                </div>
            </div>
        </div>
        <div id="searchResultBlock" style="position: relative;height: 100%;width: 100%;">
            <div id="pullrefresh" class="mui-content mui-scroll-wrapper">
                <div class="mui-scroll">
                    <div id="bookList"></div>
                    <!-- <ul class="mui-table-view" id="bookList"></ul> -->
                </div>
            </div>
            <div id="noResultBlock" style="width: 100%;height: 350px;top: 50%;display:none;" class="veryCenter innerCenter">
                <img style="width: 80px;height: 80px;" src="../source/webslice/1.2_search/search_noresult.png" alt="">
                <div style="margin-top: 30px;">
                    <p style="font-size: 16px;">暂无结果</p>
                </div>
                <div style="margin-top: 20px;">
                    <div class="mui-btn mui-btn-primary mui-btn-long" style="border-radius: 5px;min-width: 150px;">随便逛逛</div>
                </div>
            </div>
        </div>
            
    </div>
    <a href="cartPage.html" class="fixedCartButton" style="bottom: 15px;">
        <img src="../source/webslice/0_common/web_common_cart.png" />
    </a>
<div id="template" style="display: none;">
    <ul class="mui-table-view" style="margin-top: 10px;">
        <li class="mui-table-view-cell">
            <a href="indexPage_textbook.html">
                <div class="mui-table">
                    <div class="mui-table-cell mui-col-xs-3">
                        <img class="bookCoverImage" style="width: 80%;" src="" />
                    </div>
                    <div class="mui-table-cell mui-col-xs-9">
                        <h4 style="margin-bottom: 10px;font-size: 15px;" class="title mui-ellipsis"></h4>
                        <h6>作者：<span class="author"></span></h6>
                        <h6>出版社：<span class="publisher"></span>浙江教育出版社</h6>
                        <span class="mui-h4 linkColor">¥<span class="marketPrice"></span></span>
                    </div>
                </div>
            </a>
            <img class="smallCartIcon" src="../source/webslice/0_common/common_add_cart.png" />
        </li>
    </ul>
</div>
<script>
var params = getQueryData();
if(!params){
    mui.alert("查询参数错误","",["确定"],function(){
        mui.back();
    });
}
else{
    $("#searchCityInput").val(params.keyword);
    checkInputValueAndShowBlock(params.keyword);
    searchBooksByKeyWord(params.keyword, currentCityId, 0);
}
var pageCount = 0;
$("#searchCityInput").on('keyup',function(e){
    var v = $(this).val();
    checkInputValueAndShowBlock(v);
    if(e.keyCode == 13){
        if(v){
            var _params = {
                "keyword": v
            };
            window.location.search = encodeObj(_params);
        }
        else{
            mui.toast("请输入关键词");
        }
    }
});
function checkInputValueAndShowBlock(v){
    if(v){
        $("#hotSearchBlock").hide();
        $("#searchResultBlock").show();
    }
    else{
        $("#hotSearchBlock").show();
        $("#searchResultBlock").hide();
    }
}
function searchBooksByKeyWord(keyword, currentCityId, page){
    if(page == 0){
        // 清除原来的搜索结果
        $("#bookList").empty();
    }
    $.when(searchBooks(keyword, currentCityId, page)).done(function(data){
        if(data.resultCode == 200){
            var data = data.data;
            var books = data.books;
            if(books.length){
                var html = "";
                for(var i = 0, length = books.length; i < length ; i++){
                    var book = books[i];
                    html += getSingleTableCell(book.id, book.path, book.title, book.author, book.publisher, book.marketPrice);
                }
                $("#bookList").append(html);

                $("#noResultBlock").hide();
                $("#pullrefresh").show();
                pageCount++;
                // mui('#pullrefresh').pullRefresh().enablePullupToRefresh();
                mui('#pullrefresh').pullRefresh().endPullupToRefresh(false);
            }
            else{
                // 没有数据
                if(page == 0){
                    $("#noResultBlock").show();
                    $("#pullrefresh").hide();
                }
                mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
            }
        }
    });
}
function getSingleTableCell(id,path,title,author,publisher,marketPrice){
    var tableCell = $('#template').clone();
    tableCell.find('.bookCoverImage').attr("src",path).end()
        .find('.title').text(title).end()
        .find('.author').text(author).end()
        .find('.publisher').text(publisher).end()
        .find('.marketPrice').text(marketPrice).end();
    return tableCell.html();
}
mui.init({
    pullRefresh: {
        container: '#pullrefresh',
        up: {
            contentrefresh: '正在加载...',
            callback: pullupRefresh
        }
    }
});
// mui.ready(function() {
//     mui('#pullrefresh').pullRefresh().pullupLoading();
// });
count = 0;
function pullupRefresh() {
    // setTimeout(function() {
    //     mui('#pullrefresh').pullRefresh().endPullupToRefresh((++count > 2)); //参数为true代表没有更多数据了。
    //     var table = document.body.querySelector('.mui-table-view');
    //     var cells = document.body.querySelectorAll('.mui-table-view-cell');
    //     for (var i = cells.length, len = i + 20; i < len; i++) {
    //         var li = document.createElement('li');
    //         li.className = 'mui-table-view-cell';
    //         li.innerHTML = '<a class="mui-navigate-right">Item ' + (i + 1) + '</a>';
    //         table.appendChild(li);
    //     }
    // }, 1500);
console.log(pageCount);
    searchBooksByKeyWord(params.keyword, currentCityId, pageCount);
}
</script>
</body>
</html>











